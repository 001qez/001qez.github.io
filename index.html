<html>
  <head>
    <title>OneMap2 XYZ (Default)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <script src="dist/bundle.js"></script>
    <input type="text" id="inputAll" size="50" placeholder="lat lon R/W S1 S2 S3">
    <button onclick="plotFromTextbox()">Plot</button>
    <button onclick="saveMapImage()">Save map as image</button>
    <pre>
[lat] [lon] [R/W] [StationToken] [StationToken] ...
where [StationToken] is 
- Known station ID: e.g. "S06", or
- Manual station "Name@lat,lon": e.g. "S999@1.345,103.812"
</pre>
    <div id='mapdiv' style='height:500px;width:750px'></div>
  </body>
  <script>
    var stations = {
      S06: [1.357, 103.904],
      S07: [1.3418, 103.8339],
      S08: [1.37, 103.8271],
      S11: [1.3745, 103.6938],
      S23: [1.3858, 103.7119],
      S24: [1.3678, 103.9823],
      S25: [1.4114, 103.8627],
      S29: [1.3865, 103.9413],
      S33: [1.3082, 103.71],
      S35: [1.3325, 103.755],
      S40: [1.4067, 103.7832],
      S43: [1.3406, 103.8882],
      S44: [1.3458, 103.6817],
      S50: [1.3318, 103.7762],
      S60: [1.2504, 103.8275],
      S64: [1.3823, 103.7607],
      S66: [1.4387, 103.736],
      S69: [1.3704, 103.8046],
      S71: [1.2923, 103.7815],
      S77: [1.2937, 103.8127],
      S78: [1.307, 103.8907],
      S79: [1.3003, 103.8372],
      S80: [1.4247, 103.8201],
      S81: [1.4028, 103.9095],
      S84: [1.3443, 103.9441],
      S88: [1.3417, 103.8515],
      S89: [1.3199, 103.6613],
      S90: [1.3191, 103.8193],
      S92: [1.2841, 103.7888],
      S94: [1.3679, 103.9489],
      S100: [1.4172, 103.74855],
      S102: [1.1902, 103.7657],
      S104: [1.4439, 103.7854],
      S106: [1.4168, 103.9673],
      S107: [1.3133, 103.962],
      S108: [1.2799, 103.8703],
      S109: [1.3793, 103.85],
      S111: [1.3106, 103.8365],
      S112: [1.4388, 103.7017],
      S113: [1.305, 103.9112],
      S114: [1.3821, 103.7381],
      S115: [1.2938, 103.6184],
      S116: [1.2824, 103.7545],
      S117: [1.2542, 103.6741],
      S119: [1.295, 103.8622],
      S120: [1.3087, 103.818],
      S121: [1.3738, 103.7217],
      S123: [1.3214, 103.8577],
      S124: [1.36777, 103.982262],
      S125: [1.433789, 103.780731],
      S126: [1.372566, 103.724358],
      S127: [1.305738, 103.878174],
      S128: [1.354825, 103.852219],
      S129: [1.325746, 103.939691],
      S130: [1.310524, 103.763426],
      S131: [1.368423, 103.885865],
      S132: [1.337859, 103.695383],
      S137: [1.2571, 103.698],
      S140: [1.390524, 103.749664],
      S141: [1.382564, 103.84619],
      S142: [1.249503635, 103.8191777],
      S143: [1.410468643, 103.9049653],
      S139: [1.263757, 103.616417],
      S187: [1.322506, 103.80139],
      S199: [1.3678, 103.9823],
      S201: [1.32319, 103.767136],
      S203: [1.291645, 103.770203],
      S207: [1.324731, 103.958122],
      S208: [1.31363, 104.003165],
      S209: [1.421111, 103.844722],
      S210: [1.440034, 103.769036],
      S211: [1.429175, 103.757113],
      S213: [1.324273, 103.809703],
      S214: [1.299106, 103.882892],
      S215: [1.319444, 103.881944],
      S216: [1.360194, 103.853344],
      S217: [1.350278, 103.855],
      S218: [1.364907, 103.750648],
      S219: [1.379983, 103.876392],
      S220: [1.386665, 103.89797],
      S221: [1.356909, 103.890875],
      S222: [1.289872, 103.823637],
      S223: [1.299843, 103.802646],
      S224: [1.343944, 103.983863],
      S226: [1.27472, 103.80389],
      S227: [1.439444, 103.803889],
      S228: [1.347033, 103.700726],
      S229: [1.351667, 103.721944],
      S230: [1.301667, 103.76444],
      S300: [1.343007, 103.919705],
      S301: [1.415322, 103.728712],
      S302: [1.33813, 103.66303],
      S303: [1.383751, 103.658176],
      S304: [1.404648, 103.667314],
      S305: [1.421604, 103.681275],
      S306: [1.350849, 103.785966],
      S307: [1.410763, 104.041568],
      S308: [1.401584, 103.808133],
      S309: [1.3418, 103.8339],
      S310: [1.361097, 103.68257],
      S900: [1.4114, 103.8627],
      S902: [1.41457, 103.83106],
      S36: [1.337778, 103.866111],
      S46: [1.341667, 103.810833],
      S55: [1.383611, 103.886111],
      S61: [1.327222, 103.920556],
      S82: [1.324722, 103.635278],
      S91: [1.43, 103.830556],
      S101: [1.350556, 103.713333],
      S105: [1.458056, 103.795278],
      S118: [1.299444, 103.846111],
      S122: [1.417222, 103.825],
      S200: [1.3125, 103.802222],
      S202: [1.314722, 103.757778],
      S204: [1.400833, 103.882222],
      S205: [1.388333, 103.911667],
      S212: [1.318333, 103.935833],
      S225: [1.376389, 103.976667],
      S312: [1.385833, 103.711944],
      S01: [1.2666, 103.816667],
      S02: [1.3, 103.88333],
      S03: [1.4, 104.4],
      S04: [1.38333, 103.73333],
      S05: [1.3083, 103.8183],
      S09: [1.4, 103.81],
      S103: [1.364, 103.777],
      S110: [1.360606, 103.8697],
      S12: [1.331667, 103.95],
      S13: [1.2833, 103.85],
      S15: [1.35, 103.883333],
      S19: [1.271667, 103.8],
      S20: [1.34833, 103.78833],
      S206: [1.346032, 103.960997],
      S22: [1.15833, 103.74333],
      S24B: [1.3678, 103.998],
      S27: [1.315, 103.855],
      S30: [1.31, 103.846667],
      S303: [1.383751, 103.658176],
      S31: [1.272, 103.83],
      S32: [1.23333, 103.65],
      S34: [1.366667, 103.9],
      S38: [1.316667, 103.655],
      S39: [1.3262, 103.7354],
      S41: [1.415, 103.83],
      S42: [1.34, 103.795],
      S47: [1.3925, 103.8605],
      S49: [1.36667, 103.783333],
      S51: [1.4244, 103.7611],
      S52: [1.376667, 103.905],
      S54: [1.445, 103.8233],
      S56: [1.4196, 103.6965],
      S57: [1.33833, 103.66333],
      S58: [1.29, 103.776667],
      S59: [1.4106, 104.04],
      S62: [1.441667, 103.783333],
      S63: [1.3275, 103.7042],
      S72: [1.274, 103.8482],
      S74: [1.345, 103.725],
      S75: [1.373333, 103.655],
      S76: [1.462, 103.7936],
      S83: [1.376667, 103.741667],
      S85: [1.341, 103.983],
      S86: [1.3302, 103.7205],
      S93: [1.3711, 103.8643],
      S96: [1.3175, 104.0307],
      S97: [1.293894, 103.664069]
    };

    var center = L.bounds([1.49, 104.10], [1.14, 103.6]).getCenter();
    var map = L.map('mapdiv', {
      center: [center.x, center.y],
      zoom: 11,
      zoomControl: false,
      zoomSnap: 0,
      zoomDelta: 0.1
    });
    var basemap = L.tileLayer('https://www.onemap.gov.sg/maps/tiles/Grey/{z}/{x}/{y}.png', {
      //var basemap = L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      detectRetina: true,
      maxZoom: 18,
      minZoom: 10,
	  //Do not remove this attribution
      attribution: '<img src="./oneMap64-01.png" style="height:14px;width:14px;"/> OneMap | Map data &copy; contributors, SLA</a>'
    });
    //map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);
    basemap.addTo(map);

    var redIcon = new L.Icon({
      iconUrl: 'marker-icon-2x-red.png',
      shadowUrl: 'marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    var greenIcon = new L.Icon({
      iconUrl: 'marker-icon-2x-green.png',
      shadowUrl: 'marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    var blueIcon = new L.Icon({
      iconUrl: 'marker-icon-2x-blue.png',
      shadowUrl: 'marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    function plotFromTextbox() {
      const input = document.getElementById("inputAll").value.trim();
      const parts = input.split(/\s+/);
      if (parts.length < 4) {
        alert("Input format: lat lon R/W S1 S2 ...");
        return;
      }
      // 1. Parse basic values
      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);
      const zone = parts[2].toUpperCase();   // R or W
      const stationIds = parts.slice(3);
      // 2. Plot green marker (lat lon)
      L.marker([lat, lon], { icon: greenIcon }).bindTooltip(`${lat}°N, ${lon}°E`, {
        permanent: true,
        direction: 'right'
        })
        .addTo(map);
      let points = [[lat, lon]];
      // 3. Decide which stations + icon to use
      let stationSource, icon;
      if (zone === "R") {
        stationSource = stations;
        icon = blueIcon;
      } else if (zone === "W") {
        stationSource = stations;
        icon = redIcon;
      } else {
        alert("Third value must be R or W");
        return;
      }
      // 4. Plot stations
      stationIds.forEach(token => {
        let coord, label;
        // Case 1: Named manual station "Name@lat,lon"
        if (token.includes("@")) {
          const [name, coordPart] = token.split("@");
          const parts = coordPart.split(",");
          if (parts.length !== 2) {
            console.warn("Invalid named station:", token);
            return;
          }
          const lat = parseFloat(parts[0]);
          const lon = parseFloat(parts[1]);
          if (isNaN(lat) || isNaN(lon)) {
            console.warn("Invalid coordinates:", token);
            return;
          }
          coord = [lat, lon];
          label = name;
        }
        // Case 2: Known station ID
        else if (stationSource[token]) {
          coord = stationSource[token];
          label = token;
        }
        // Case 3: Invalid token
        else {
          console.warn(
            "Invalid station token (must be ID or Name@lat,lon):",
            token
          );
          return;
        }
        // Plot marker
        L.marker(coord, { icon })
          .bindTooltip(label, {
            permanent: true,
            direction: 'right'
          })
          .addTo(map);
        points.push(coord);
      });
      // 5. Fit map to all points
      map.fitBounds(L.latLngBounds(points).pad(0.3));
    }

function saveMapImage() {
  const mapDiv = document.getElementById("mapdiv");

  html2canvas(mapDiv, {
    useCORS: true,
    backgroundColor: "#ffffff"
  }).then(canvas => {

    // Convert canvas to image
    const image = canvas.toDataURL("image/png");

    // Create download link
    const link = document.createElement("a");
    link.href = image;
    link.download = "map.png";

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
}

  </script>
</html>
